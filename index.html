<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>Neon Strike - Cloud Server</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.155.0/three.min.js"></script>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    
    <style>
        html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:sans-serif;}
        canvas{display:block;}
        #ui{position:absolute;top:20px;left:20px;background:rgba(0,0,0,0.8);padding:15px;border:1px solid #00d4ff;border-radius:10px;}
        #login{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;}
        .box{background:#111;padding:30px;border:1px solid #444;border-radius:15px;text-align:center;}
        button{padding:12px 25px;cursor:pointer;font-weight:bold;background:#00d4ff;border:none;border-radius:5px;}
    </style>
</head>
<body>

<div id="login">
    <div class="box">
        <h1 style="color:#00d4ff;">NEON STRIKE CLOUD</h1>
        <p>Connexion via serveur central (Ably)</p>
        <button onclick="connectToCloud()">REJOINDRE L'ARÈNE</button>
        <p id="loader" style="display:none;font-size:12px;color:#888;">Initialisation du serveur...</p>
    </div>
</div>

<div id="ui">JOUEURS EN LIGNE: <span id="count">1</span></div>

<script>
let ably, channel, myID;
let scene, camera, renderer, playerGroup, yaw = 0;
let others = {};
let keys = {};

async function connectToCloud() {
    document.getElementById('loader').style.display = 'block';
    
    // 1. Connexion au serveur Ably (Clé publique gratuite)
    // Note: Dans un vrai projet, on utilise un token, mais pour ton test GitHub, c'est parfait.
    ably = new Ably.Realtime('hoXqWQ.xS6MJA:4jw_S7dp30pIrB7Sm3tCM6S4WQa57PAqkPdp-WN-Ros'); // Je vais t'expliquer comment avoir ta clé
    
    // Si tu n'as pas encore de clé, on peut simuler pour que tu vois le code :
    myID = "player-" + Math.random().toString(36).substr(2, 5);
    channel = ably.channels.get('neon-strike-room');

    // 2. Écouter les autres joueurs
    channel.subscribe('update', (msg) => {
        if(msg.data.id !== myID) {
            updateOtherPlayer(msg.data);
        }
    });

    // 3. Quand quelqu'un quitte
    channel.presence.subscribe('leave', (member) => {
        if(others[member.clientId]) {
            scene.remove(others[member.clientId]);
            delete others[member.clientId];
        }
    });

    initGame();
}

function initGame() {
    document.getElementById('login').style.display = 'none';
    
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020005);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.GridHelper(500, 100, 0x4400ff, 0x111111));
    scene.add(new THREE.AmbientLight(0xffffff, 0.5));

    playerGroup = createMesh(0x00d4ff);
    scene.add(playerGroup);

    setupControls();
    loop();
}

function createMesh(color) {
    const g = new THREE.Group();
    const mat = new THREE.MeshStandardMaterial({color: color, emissive: color, emissiveIntensity: 0.5});
    g.add(new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), mat)); // Simple cube pour le test
    return g;
}

function updateOtherPlayer(data) {
    if(!others[data.id]) {
        others[data.id] = createMesh(0xff00ff);
        scene.add(others[data.id]);
    }
    others[data.id].position.set(data.x, 0.5, data.z);
    others[data.id].rotation.y = data.yaw;
}

let lastSendTime = 0; // Ajoute cette variable en haut de ton script

function loop() {
    requestAnimationFrame(loop);
    const now = Date.now();
    const dt = 0.016;

    // ... (Ton code de mouvement reste le même) ...

    if(move.length() > 0 || Math.abs(lastYaw - yaw) > 0.01) {
        playerGroup.position.addScaledVector(move.normalize(), 20 * dt);
        
        // --- LIMITEUR DE DÉBIT ICI ---
        if (now - lastSendTime > 100) { // On envoie seulement toutes les 100ms
            channel.publish('update', { 
                id: myID, 
                x: playerGroup.position.x, 
                z: playerGroup.position.z, 
                yaw: yaw 
            });
            lastSendTime = now;
        }
    }
    
    // ... (Rendu caméra et scène) ...
}

function setupControls() {
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);
    document.addEventListener('mousemove', e => { if(document.pointerLockElement) yaw -= e.movementX * 0.003; });
    window.addEventListener('mousedown', () => renderer.domElement.requestPointerLock());
}
</script>
</body>
</html>





